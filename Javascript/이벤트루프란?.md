## 이벤트 루프란?
이벤트 루프가 무엇이고 왜 신경써야할까요?
javascript는 싱글 스레드입니다. 한번에 하나의 작업만 할 수 있다는 의미죠.
일반적으로 큰 문제는 아니지만, 30초가 걸리는 작업을 실행하고 있다고 상상해봅시다.
그 작업동안 우리는 다른 일이 일어날 때 까지 30초동안 기다리고 있어야 합니다.
그럼 매우 느리고 반응없는 웹사이트가 되는 상태인 것입니다.

브라우저는 자바스크립트 엔진에서 제공하지 않는 몇가지 기능인  Web API를 제공합니다.
여기에는 DOM API, setTimeout, HTTP요청등이 포함됩니다. 이것은 비동기, 비차단 동작을 만드는데 도움이 될 수 있어요.

함수를 호출하면 `콜스택(호출스택)`이라는 것에 추가가 되는데요.
콜스택은 자바스크립트 엔진의 일부이고 브라우저에 따라 다릅니다. 이것은 스택입니다. 즉, 선입후출의 방식인거죠. 함수가 값을 반환하면 해당 함수가 스택에서 꺼냅니다.

```js
function greet() {
return "Hello1"
}

function response() {
 return setTimeout(() =>{
 return "Hey!"
 },1000))
}

greet()
respond()
```
respond함수는 setTimeout 함수를 반환합니다. setTimeout은 웹 API에 의해 제공됩니다.
메인스레드를 차단하지 않고 작업을 지연시킬 수 있습니다.
setTimeout함수에 전달한 콜백 함수, 화살표함수 ()=>{return "Hey!"}가 Web API에 추가됩니다.
그러는동안 setTimeout함수와 respond함수가 스택에서 꺼내지면서 둘 다 값을 반환합니다.

webAPI에서 타이머는 전달한 두번째 인수인 1000ms동안 실행됩니다. 콜백은 즉시 콜스택에 추가되지 않고 큐라고 하는 것으로 전달됩니다.
1000ms 후에 단순히 큐에 추가됩니다. 함수는 차례를 기다려야 합니다.

`이벤트 루프가 유일한 작업을 수행할 시간은 큐를 콜스택과 연결하는 것입니다.` 콜스택이 비어있으면 이전에 호출된 모든 함수가 값을 반환하고 스택에서 꺼낸 경우 큐의 첫번째 항목이 콜스택에 추가됩니다.콜백이 콜스택에 추가되고 호출되고 값을 반환하고 스택에서 꺼냅니다.

이벤트 루프는 콜스택과 콜백 큐의 상태를 계속 감시하며 콜스택에 함수들이 존재하지 않으면 콜백 큐에 있는 비동기 함수들을 콜 스택에 밀어넣습니다. 그 후 콜 스택에서 비동기 함수를 실행시키게 되는 것이죠.


### 단일 스레드

자바스크립트는 싱글 스레드입니다. 한번에 하나의 작업만 처리할 수 있다는 의미입니다. 하지만 자바스크립트로 개발하면 동시에 작업이 처리되는 것을 알 수 있습니다. 이벤트가 일어날 때 다른 작업도 진행하고 한 번에 여러 개의 HTTP 요청을 처리하기도 합니다. 어떻게 단일 스레드인데 이런일이 가능할까요? 어떻게 동시에 여러 작업을 할 수 있을까요? 바로 `이벤트 루프`덕분입니다.
자바스크립트는 이벤트 루프를 이용해서 비동기 방식으로 동시성을 지원합니다.


## 콜스택과 콜백 큐

이벤트 루프는 싱글 스레드 루프로 콜 스택을 모니터링하면서 태스크 큐에 실행해야할 작업이 있는지 확인한다. 만약 콜 스택이 비어있고 태스크 큐에 콜백함수가 있다면, 함수는 큐에서 제거되고 실행을 위해 콜스택에 추가된다.

console.log같은 동기 함수는 스택에 바로 들어가 실행된다. 하지만 비동기 web api인 setTimeout은 스택에 들어간 후 바로 지워지고 대신 웹브라우저에서 타이머를 실행시킨다. 타이머가 끝나면 콜백을 태스크 큐에 추가하고, 모니터링하고 있던 이벤트 루프가 콜백을 스택에 추가해서 실행한다. 콜백 안에 비동기 함수가 있다면 비슷한 과정이 반복될 것입니다.

`콜백 큐 (Callback Queue)`
콜백 큐는 비동기적으로 실행된 콜백함수가 보관되는 영역이다
큐는 자료 구조중 하나로 선입 선출의 룰을 따른다.
일종의 대기열과 같은 개념. setTimeout,setInterval,setImmediate등과 같은 비동기 처리나 이벤트리스너의 콜백과 같은 처리는 태스크 큐로 들어간다.

`콜스택(Call stack)`
코드가 실행될 때 하나씩 stack의 형태로 쌓인다.
스택은 자료 구조중 하나로 선입 후출의 룰을 따른다.
콜 스택은 자바스크립트 엔진에 위치한다.
작동되는 순서에 따라 차례대로 콜 스택에 들어가고, 값을 반환하면 콜 스택에서 지워진다. 자바스크립트는 싱글 스레드(한번에 코드 한줄밖에 실행 못함) 를 기반으로 하기에 단 한줄의 콜 스택만 존재한다.


자바스크립트는 동기언어인데, 비동기 처리가능(setTimeout,이벤트리스너,ajax함수)
자바스크립트는 싱글 스레드이지만 Web api, callback queue, event loop 덕분에 멀티 스레드처럼 보여진다.

## 자바스크립트 엔진

자바스크립트 엔진의 대표적인 예는 google v8엔진이다. v8은 chrome과 Node.js에서 사용한다. 엔진의 주요 두 구성요소는 Memory Heap(메모리 할당이 일어나는 곳), call stack (코드 실행에 따라 호출 스택이 쌓이는 곳)




참고: https://www.devh.kr/2021/JavaScript-Visualized-Event-Loop/
